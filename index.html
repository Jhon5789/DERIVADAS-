<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Calculadora de Derivadas</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- MathJax para mostrar fórmulas -->
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    #grafica {
      max-width: 700px;
      margin-top: 40px;
    }
    input[type="text"] {
      width: 300px;
    }
    .resultado {
      margin-top: 20px;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <h2>Calculadora de Derivadas</h2>
  <label>Ingresa una función f(x):</label>
  <input type="text" id="funcion" value="x^2 + 2*x + 1">
  <button onclick="calcular()">Calcular</button>

  <div class="resultado" id="derivadaCorta"></div>
  <div class="resultado" id="pasosLargos"></div>
  <canvas id="grafica" width="600" height="400"></canvas>

  <script>
    function calcular() {
      const expr = document.getElementById("funcion").value;
      const x = math.parse('x');
      const f = math.parse(expr);
      const scope = { x: 0 };

      // Derivada corta
      const df = math.derivative(f, 'x');
      document.getElementById("derivadaCorta").innerHTML = 
        "<b>Derivada por método corto:</b><br>\\( f'(x) = " + df.toTex({ parenthesis: 'keep' }) + " \\)";
      MathJax.typeset();

      // Pasos largos con límite
      derivadaPorDefinicionDetallada(expr);

      // Gráfica
      graficarFuncion(expr, df.toString());
    }

    function derivadaPorDefinicionDetallada(expr) {
      const f = math.parse(expr);
      const h = math.parse('h');
      const x = math.parse('x');
      const fx = f.toString();

      // f(x+h)
      const fxh = f.transform(function (node) {
        if (node.isSymbolNode && node.name === 'x') {
          return math.parse('(x + h)');
        }
        return node;
      });

      // f(x+h) - f(x)
      const diferencia = math.simplify(`(${fxh.toString()}) - (${fx})`);

      // [(f(x+h) - f(x))] / h
      const cociente = math.simplify(`(${diferencia.toString()}) / h`);

      // Límite cuando h → 0
      const derivadaFormal = math.derivative(f, 'x'); // usamos derivada formal al final
      const latex = `
        <b>Derivada por definición (método largo):</b><br>
        \\[
        f'(x) = \\lim_{h \\to 0} \\frac{f(x+h) - f(x)}{h}
        \\]
        <b>1. f(x):</b> \\( ${math.parse(expr).toTex()} \\)<br><br>
        <b>2. f(x+h):</b> \\( ${fxh.toTex()} \\)<br><br>
        <b>3. f(x+h) - f(x):</b> \\( ${diferencia.toTex()} \\)<br><br>
        <b>4. \\frac{f(x+h) - f(x)}{h}:</b> \\( ${cociente.toTex()} \\)<br><br>
        <b>5. Límite cuando h → 0:</b> \\( f'(x) = ${derivadaFormal.toTex()} \\)
      `;

      document.getElementById("pasosLargos").innerHTML = latex;
      MathJax.typeset();
    }

    function graficarFuncion(funcionStr, derivadaStr) {
      const ctx = document.getElementById('grafica').getContext('2d');

      let f = math.compile(funcionStr);
      let df = math.compile(derivadaStr);

      let x_vals = [], y_vals = [], dy_vals = [];
      for (let x = -10; x <= 10; x += 0.2) {
        try {
          x_vals.push(x);
          y_vals.push(f.evaluate({x: x}));
          dy_vals.push(df.evaluate({x: x}));
        } catch {
          x_vals.push(x);
          y_vals.push(null);
          dy_vals.push(null);
        }
      }

      if (window.miGrafico) window.miGrafico.destroy(); // Evitar superposición
      window.miGrafico = new Chart(ctx, {
        type: 'line',
        data: {
          labels: x_vals,
          datasets: [
            {
              label: 'f(x)',
              data: y_vals,
              borderWidth: 2,
              fill: false
            },
            {
              label: "f'(x)",
              data: dy_vals,
              borderDash: [5, 5],
              borderWidth: 2,
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: { title: { display: true, text: 'x' } },
            y: { title: { display: true, text: 'y' } }
          }
        }
      });
    }
  </script>
</body>
</html>
