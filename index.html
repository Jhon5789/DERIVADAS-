function resolverMetodoLargo() {
  const funcion = document.getElementById("funcion").value.trim();
  const valorxRaw = document.getElementById("valorx").value.trim();
  const output = document.getElementById("output");
  const steps = document.getElementById("mathSteps");
  output.innerHTML = '';
  steps.innerHTML = '';

  if (!validarFuncion(funcion)) {
    output.textContent = "⚠️ Por favor, ingresa una función válida.";
    return;
  }

  const h = 0.000001;
  let valorx = null;
  if (valorxRaw !== '') {
    valorx = parseFloat(valorxRaw);
    if (isNaN(valorx)) {
      output.textContent = "⚠️ El valor de x debe ser un número válido.";
      return;
    }
  }

  try {
    // Expresión con x+h para mostrar en LaTeX
    const funcionConXh = funcion.replace(/x/g, `(x + h)`);
    const f_x_latex = math.parse(funcion).toTex();
    const f_xh_latex = math.parse(funcionConXh).toTex();

    // Paso 1: Definición límite
    let paso1 = `f'(x) = \\lim_{h \\to 0} \\frac{f(x+h) - f(x)}{h}`;

    // Paso 2: sustitución simbólica
    let paso2 = `= \\lim_{h \\to 0} \\frac{${f_xh_latex} - ${f_x_latex}}{h}`;

    output.innerHTML = `\\[
      \\text{Función: } f(x) = ${f_x_latex}
    \\]`;

    if (valorx === null) {
      // Solo mostrar definición y sustitución simbólica (sin cálculo numérico)
      steps.innerHTML = `\\[
        \\text{Paso 1 – Definición formal:} \\\\
        ${paso1} \\\\[10pt]
        \\text{Paso 2 – Sustitución simbólica:} \\\\
        ${paso2}
      \\]`;
      MathJax.typesetPromise();
      return;
    }

    // Si hay valor numérico, hacer cálculo numérico y derivada simbólica

    const f_x = math.evaluate(funcion, { x: valorx });
    const f_xh = math.evaluate(funcionConXh, { x: valorx, h: h });
    const diferencia = (f_xh - f_x) / h;

    const derivadaSimbolica = math.derivative(funcion, 'x').toString();
    const derivadaSimbolicaTex = math.parse(derivadaSimbolica).toTex();
    const valorDerivadaEnX = math.evaluate(derivadaSimbolica, { x: valorx });

    let paso3 = `\\approx \\frac{f(${valorx} + h) - f(${valorx})}{h} = \\frac{${f_xh.toFixed(7)} - ${f_x.toFixed(7)}}{${h}} = ${diferencia.toFixed(7)}`;

    let paso4 = `\\text{Derivada simbólica final: } f'(x) = ${derivadaSimbolicaTex}`;

    let paso5 = `\\text{Valor numérico en } x=${valorx}: f'(${valorx}) = ${valorDerivadaEnX.toFixed(7)}`;

    steps.innerHTML = `\\[
      \\text{Paso 1 – Definición formal:} \\\\
      ${paso1} \\\\[10pt]
      \\text{Paso 2 – Sustitución simbólica:} \\\\
      ${paso2} \\\\[10pt]
      \\text{Paso 3 – Cálculo numérico aproximado:} \\\\
      ${paso3} \\\\[10pt]
      \\text{Paso 4 – Derivada simbólica:} \\\\
      ${paso4} \\\\[10pt]
      \\text{Paso 5 – Valor numérico:} \\\\
      ${paso5}
    \\]`;

    MathJax.typesetPromise();

  } catch (error) {
    output.textContent = "⚠️ Error al evaluar la función. Verifica la expresión.";
  }
}
